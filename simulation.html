<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Epimetabolic Simulation — The Dionysus Program</title>
  <meta name="description" content="Interactive simulation of the Epimetabolic Equation from The Dionysus Program.">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main>
    <header class="page-header">
      <h1>The Dionysus Program</h1>
      <p class="page-subtitle">An Epimetabolic Simulation</p>
      <p class="page-download">
        <a href="index.html">← Back to Essay</a>
      </p>
    </header>

    <div id="epimetabolic-simulation-root" class="simulation-container"></div>

    <footer class="page-footer">
      <p class="page-rights">© 2025 Sean Devine. All rights reserved.</p>
    </footer>
  </main>

<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "recharts": "https://esm.sh/recharts@2.12.7?external=react"
  }
}
</script>

<script type="module">
import React, { useState, useEffect, createElement as h } from 'react';
import { createRoot } from 'react-dom/client';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from 'recharts';

const RefreshIcon = () => h('svg', { width: 12, height: 12, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
  h('path', { d: 'M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8' }),
  h('path', { d: 'M3 3v5h5' }),
  h('path', { d: 'M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16' }),
  h('path', { d: 'M16 16h5v5' })
);

const InfoIcon = () => h('svg', { width: 18, height: 18, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', className: 'sim-info-icon' },
  h('circle', { cx: 12, cy: 12, r: 10 }),
  h('path', { d: 'M12 16v-4' }),
  h('path', { d: 'M12 8h.01' })
);

const SettingsIcon = () => h('svg', { width: 12, height: 12, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
  h('path', { d: 'M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z' }),
  h('circle', { cx: 12, cy: 12, r: 3 })
);

function SliderControl({ label, symbol, value, min, max, step, desc, onChange }) {
  return h('div', { className: 'sim-slider-group' },
    h('div', { className: 'sim-slider-header' },
      h('label', { className: 'sim-slider-label' },
        h('span', { className: 'sim-symbol' }, symbol),
        ' ',
        label
      ),
      h('span', { className: 'sim-slider-value' }, value)
    ),
    h('p', { className: 'sim-slider-desc' }, desc),
    h('input', {
      type: 'range',
      min: min,
      max: max,
      step: step,
      value: value,
      onChange: function(e) { onChange(parseFloat(e.target.value)); },
      className: 'sim-slider'
    })
  );
}

function EpimetabolicSimulation() {
  const [inputs, setInputs] = useState({
    mu: 5.0,
    L: 8.0,
    rho: 0.1,
    beta: 1.0,
    tau: 1.5,
    R0: 100.0,
    alpha: 0.02,
    gamma: 0.10,
    delta: 0.05,
    kappa: 0.50,
    lambda: 0.20
  });

  const [simulationData, setSimulationData] = useState([]);
  const [seed, setSeed] = useState(Date.now());

  useEffect(function() {
    var data = [];
    var S = 10.0;
    var R = inputs.R0;
    var C = 1.0;

    var randomVals = [];
    for (var i = 0; i < 100; i++) {
      var x = Math.sin(seed + i) * 10000;
      randomVals.push(x - Math.floor(x));
    }

    for (var t = 0; t < 100; t++) {
      var Omega = Math.min(inputs.L * C, R);
      var Theater = Math.max(0, (inputs.L * C) - R);
      var Overflow = Math.max(0, inputs.mu - Omega);

      var G = Math.min(inputs.mu, Omega) * (1 + inputs.lambda * inputs.beta);
      var safeBeta = Math.max(0.1, inputs.beta);
      var D = (Math.pow(Overflow, 2) * inputs.tau) + ((inputs.kappa * Theater) / safeBeta);

      var deltaS = G - D;
      S = S + deltaS;

      var R_prev = R;
      R = Math.max(0, R + (inputs.alpha * safeBeta * G) - (inputs.gamma * D));

      var isReset = randomVals[t] < inputs.rho;
      var C_prev = C;

      if (isReset) {
        C = 1.0;
      } else {
        C = C * (1 - inputs.delta);
      }

      data.push({
        t: t,
        S: parseFloat(S.toFixed(2)),
        R: parseFloat(R.toFixed(2)),
        C: parseFloat(C_prev.toFixed(2))
      });

      if (R <= 0) break;
    }

    setSimulationData(data);
  }, [inputs, seed]);

  function updateInput(key, value) {
    setInputs(function(prev) {
      var next = Object.assign({}, prev);
      next[key] = value;
      return next;
    });
  }

  var lastData = simulationData[simulationData.length - 1] || { S: 0, R: 0 };
  var collapsed = simulationData.length < 100;

  return h('div', { className: 'sim-wrapper' },
    // Chart at full width
    h('div', { className: 'sim-chart-container' },
      h('div', { className: 'sim-chart-header' },
        h('h4', { className: 'sim-chart-title' }, 'System Evolution ', h('span', { className: 'sim-chart-range' }, '(t=0 to 100)')),
        collapsed && h('span', { className: 'sim-death-spiral' }, 'Death Spiral Detected')
      ),
      h('div', { className: 'sim-chart' },
        h(ResponsiveContainer, { width: '100%', height: '100%' },
          h(LineChart, { data: simulationData, margin: { top: 5, right: 30, left: 0, bottom: 5 } },
            h(CartesianGrid, { strokeDasharray: '3 3', stroke: '#e7e2da', vertical: false }),
            h(XAxis, { dataKey: 't', type: 'number', domain: [0, 100], stroke: '#9ca3af', tickLine: false, axisLine: { stroke: '#e5e7eb' }, tick: { fill: '#9ca3af', fontSize: 10 } }),
            h(YAxis, { yAxisId: 'left', stroke: '#4b5563', tick: { fill: '#6b7280', fontSize: 10 }, axisLine: false, tickLine: false }),
            h(YAxis, { yAxisId: 'right', orientation: 'right', domain: [0, 1], hide: true }),
            h(Tooltip, { contentStyle: { backgroundColor: '#faf8f4', borderColor: '#e7e2da', fontFamily: '"Iowan Old Style", Palatino, serif', fontSize: '14px', boxShadow: '0 4px 6px -1px rgba(0,0,0,0.1)', padding: '12px' }, itemStyle: { color: '#333' }, labelStyle: { color: '#9ca3af', marginBottom: '8px', fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.1em' } }),
            h(Legend, { verticalAlign: 'top', height: 36, iconType: 'plainline', wrapperStyle: { paddingBottom: '20px', fontSize: '12px', fontFamily: 'system-ui, sans-serif' } }),
            h(Line, { yAxisId: 'left', type: 'monotone', dataKey: 'S', name: 'Explanatory Reach (S)', stroke: '#41403b', strokeWidth: 2.5, dot: false, activeDot: { r: 5, fill: '#41403b', stroke: '#fff', strokeWidth: 2 }, isAnimationActive: true, animationDuration: 1000 }),
            h(Line, { yAxisId: 'left', type: 'monotone', dataKey: 'R', name: 'Ren (Trust)', stroke: '#b45309', strokeWidth: 2, strokeDasharray: '4 4', dot: false, activeDot: { r: 5, fill: '#b45309', stroke: '#fff', strokeWidth: 2 }, isAnimationActive: true, animationDuration: 1000 }),
            h(Line, { yAxisId: 'right', type: 'stepAfter', dataKey: 'C', name: 'Stewardship (C)', stroke: '#d4d4d4', strokeWidth: 1.5, dot: false, isAnimationActive: false })
          )
        )
      )
    ),
    // Metrics row
    h('div', { className: 'sim-metrics' },
      h('div', { className: 'sim-metric sim-metric-reach' },
        h('h5', { className: 'sim-metric-title' }, 'Final Reach (', h('em', null, 'S'), ')'),
        h('div', { className: 'sim-metric-value-row' },
          h('div', { className: 'sim-metric-value' }, lastData.S.toFixed(1)),
          h('div', { className: 'sim-metric-delta ' + (lastData.S > 10 ? 'positive' : 'negative') },
            (lastData.S - 10) > 0 ? '+' : '',
            (lastData.S - 10).toFixed(1)
          )
        ),
        h('div', { className: 'sim-metric-hint' }, 'Target: Maximize S without breaking R.')
      ),
      h('div', { className: 'sim-metric sim-metric-trust ' + (collapsed ? 'collapsed' : '') },
        h('h5', { className: 'sim-metric-title' }, 'Ren (Trust) (', h('em', null, 'R'), ')'),
        h('div', { className: 'sim-metric-value' }, lastData.R.toFixed(1)),
        h('div', { className: 'sim-metric-status ' + (collapsed ? 'danger' : 'ok') },
          collapsed ? 'Collapse at t=' + simulationData.length : 'System Survives'
        )
      )
    ),
    // Two-column controls
    h('div', { className: 'sim-controls-grid' },
      h('div', { className: 'sim-controls-col' },
        h('h4', { className: 'sim-section-title' }, 'Variables'),
        h(SliderControl, { label: 'Initial Ren (Trust)', symbol: 'R₀', value: inputs.R0, min: 10, max: 200, step: 10, desc: 'Starting social capital / trust.', onChange: function(v) { updateInput('R0', v); } }),
        h(SliderControl, { label: 'Melt Rate', symbol: 'μ', value: inputs.mu, min: 0, max: 20, step: 0.5, desc: 'Intensity of exogenous disruption.', onChange: function(v) { updateInput('mu', v); } }),
        h(SliderControl, { label: 'Li (Ritual)', symbol: 'L', value: inputs.L, min: 1, max: 20, step: 0.5, desc: 'Architectural capacity of the forms.', onChange: function(v) { updateInput('L', v); } }),
        h(SliderControl, { label: 'Rotation Rate', symbol: 'ρ', value: inputs.rho, min: 0, max: 1, step: 0.05, desc: 'Frequency of stewardship reset.', onChange: function(v) { updateInput('rho', v); } }),
        h(SliderControl, { label: 'Beauty', symbol: 'β', value: inputs.beta, min: 0.1, max: 5, step: 0.1, desc: 'Thermal buffer and multiplier.', onChange: function(v) { updateInput('beta', v); } }),
        h(SliderControl, { label: 'Toxicity', symbol: 'τ', value: inputs.tau, min: 0.5, max: 5, step: 0.1, desc: 'Penalty for unprocessed error.', onChange: function(v) { updateInput('tau', v); } })
      ),
      h('div', { className: 'sim-controls-col' },
        h('h4', { className: 'sim-section-title' }, 'Constants'),
        h(SliderControl, { label: 'Earn Rate', symbol: 'α', value: inputs.alpha, min: 0.01, max: 0.1, step: 0.01, desc: 'Trust gained per unit of metabolized error.', onChange: function(v) { updateInput('alpha', v); } }),
        h(SliderControl, { label: 'Burn Rate', symbol: 'γ', value: inputs.gamma, min: 0.01, max: 0.5, step: 0.01, desc: 'Trust destroyed per unit of toxic overflow.', onChange: function(v) { updateInput('gamma', v); } }),
        h(SliderControl, { label: 'Oligarchic Drift', symbol: 'δ', value: inputs.delta, min: 0.01, max: 0.2, step: 0.01, desc: 'Rate of stewardship decay per cycle.', onChange: function(v) { updateInput('delta', v); } }),
        h(SliderControl, { label: 'Hollow Penalty', symbol: 'κ', value: inputs.kappa, min: 0.1, max: 2.0, step: 0.1, desc: 'Damage from ritual exceeding trust.', onChange: function(v) { updateInput('kappa', v); } }),
        h(SliderControl, { label: 'Aesthetic Multi', symbol: 'λ', value: inputs.lambda, min: 0.05, max: 1.0, step: 0.05, desc: 'Efficiency gain from high beauty.', onChange: function(v) { updateInput('lambda', v); } }),
        h('div', { className: 'sim-reroll' },
          h('button', { onClick: function() { setSeed(Date.now()); }, className: 'sim-reroll-btn' },
            h(RefreshIcon),
            ' New Random Seed'
          )
        )
      )
    ),
    // Info box
    h('div', { className: 'sim-info' },
      h('div', { className: 'sim-info-content' },
        h(InfoIcon),
        h('div', null,
          h('p', null,
            h('strong', null, 'How to read this model:'),
            ' The black line represents ',
            h('em', null, 'Explanatory Reach (S)'),
            '—the ability of the organization to solve problems. The dashed gold line is ',
            h('em', null, 'Ren / Trust (R)'),
            '. The faint gray background line tracks ',
            h('em', null, 'Stewardship (C)'),
            '.'
          ),
          h('p', null,
            h('strong', null, 'Observation:'),
            ' Note that high ',
            h('strong', null, 'Melt (μ)'),
            ' allows for rapid growth in Reach, but generates ',
            h('strong', null, 'Overflow'),
            ' if Ritual Capacity (L) is too low. This overflow becomes toxic decay (D), burning Trust faster than it can be earned.'
          )
        )
      )
    )
  );
}

const root = createRoot(document.getElementById('epimetabolic-simulation-root'));
root.render(h(EpimetabolicSimulation));
</script>
</body>
</html>
